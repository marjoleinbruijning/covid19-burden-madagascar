---
title: "Estimating the burden of COVID-19 in African countries"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: fill
    orientation: rows
    source_code: embed
    theme: simplex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

# Load Packages
library(highcharter)
library(htmltools)
library(rio)
library(stringr)
library(DT)
library(dplyr)
library(jsonlite)
library(data.table)
library(leaflet)

```


```{r ests, include = FALSE}
# read in data
country <- fromJSON("output/geojson/country.geojson", simplifyVector = FALSE)
admin <-  fromJSON("output/geojson/admin2.geojson", simplifyVector = FALSE)
country_dt <- fread("output/country_dt.csv")
admin_dt <- fread("output/admin2_dt.csv")

# get cfrs
# Per Jess
age.upper <- c(9, 19, 29, 39, 49, 59, 69, 79, 89)
N.cases <- c(416, 549, 3619, 7600, 8571, 10008, 8583, 3918, 1408)
N.deaths <- c(0, 1, 7, 18, 38, 130, 309, 312, 208)
CFR <- N.deaths/N.cases
fit.cfr <- smooth.spline(age.upper - 4.5, (N.deaths/ N.cases)) # mid-point of age bracket & cases/deaths

# take midpoint of our age brackets for afr data
age_lower <- seq(0, 65, by = 5)
age_upper <- age_lower + 4 # keep age upper at 69 (conservative estimates of mortality)
mid_pt <- (age_lower + age_upper)/2
cfr <- pmax(predict(fit.cfr, mid_pt)$y, 0)
names(cfr) <- c("A0004", "A0509", "A1014", "A1519", "A2024", "A2529", "A3034", "A3539", "A4044",
                "A4549", "A5054", "A5559", "A6064", "A65PL") # names should match colnames!
p_infected <- 0.3 # 30% cummulative infections

# Relative symptomatic by age (taking mid_pt of age bins)
cm_interpolate_cos <- function(x, x0, y0, x1, y1) {
  ifelse(x < x0, y0, 
         ifelse(x > x1, y1, y0 + (y1 - y0) * (0.5 - 0.5 * cos(pi * (x - x0) / (x1 - x0)))))
}
symp.pars <- data.frame("age_y" = 14, "age_m" = 55, "age_o" = 64, "symp_y" = 0.056,
                      "symp_m"= 0.49, "symp_o"= 0.74)
young  = cm_interpolate_cos(mid_pt, symp.pars$age_y, 1, symp.pars$age_m, 0);
old    = cm_interpolate_cos(mid_pt, symp.pars$age_m, 0, symp.pars$age_o, 1);
middle = 1 - young - old;
rel.symp <- young * symp.pars$symp_y + middle * symp.pars$symp_m + old * symp.pars$symp_o
names(rel.symp) <- c("A0004", "A0509", "A1014", "A1519", "A2024", "A2529", "A3034", "A3539", 
                     "A4044", "A4549", "A5054", "A5559", "A6064", "A65PL") # names should match colnames!

# apply to data @ country/admin level
admin_dt[, (paste0("deaths_", names(cfr))) :=  Map("*", .SD, cfr*p_infected*rel.symp), 
                           .SDcols = names(cfr)]
admin_dt$deaths_total <- rowSums(admin_dt[, paste0("deaths_", names(cfr)), with = FALSE], 
                                   na.rm = TRUE)
admin_dt$prop_ov65 <- admin_dt$A65PL/admin_dt$pop
admin_dt$inc_per100k <- admin_dt$deaths_total/admin_dt$pop*1e5

# country level
country_dt[, (paste0("deaths_", names(cfr))) :=  Map("*", .SD, cfr*p_infected*rel.symp), 
                           .SDcols = names(cfr)]
country_dt$deaths_total <- rowSums(country_dt[, paste0("deaths_", names(cfr)), with = FALSE], 
                                   na.rm = TRUE)
country_dt$prop_ov65 <- country_dt$A65PL/country_dt$pop
country_dt$inc_per100k <- country_dt$deaths_total/country_dt$pop*1e5

```


Sidebar {.sidebar}
======================================================================
The goal of this project is to map the potential burden of COVID-19 in African countries. Currently we are focusing on demography, but hope to incorporate other factors such as healthcare capacity.

A summary of our approach is described in the __Methods__ tab. We use demographic data from [WorldPop](https://www.worldpop.org/geodata/summary?id=1276), administrative data from The Malaria Atlas Project (https://malariaatlas.org) accessed through the R package [`malariaAtlas`](https://cran.r-project.org/web/packages/malariaAtlas/index.html). We also have summarized data from [Alegana et al] on probability of seeking treatment and travel times to health facilities. Download these data and the associated metadata here. We take data from Verity et al. & also assume cummulative infection rates.


To explore these assumptions, check out our shiny app. [here](https://marjoleinbruijning.shinyapps.io/covid19-burden-africa/).

This project is an offshoot of this work by [Miller et al](https://github.com/ianfmiller/covid19-burden-mapping) mapping burden and hospital capacity in the US.

All code & data are available [here].

Mapping burden
======================================================================

Row {{data-height=1000}}
-----------------------------------------------------------------------

### Burden mapped to country & Admin 2 level (where available)

```{r}
# From http://leafletjs.com/examples/choropleth/us-states.js
admin2 <- readOGR("output/shapefiles/admin2.shp")
admin2$shape_id <- 1:nrow(admin2@data)
country <- readOGR("output/shapefiles/country.shp")

# merge
admin2@data <- left_join(admin2@data, admin_dt)

bins <- c(0, 50, 100, 150, 250, 300)
pal <- colorBin("YlOrRd", domain = admin2$inc_per100k, bins = bins)

labels <- sprintf(
  "<strong>Admin name (type): %s (%s)</strong><br/> <strong>Country: %s</strong><br/> Pop: %s <br/> Prop pop over 65: %0.3g <br/> Total # of deaths: %0.2f <br/> Estimated reporting of fevers to health centers: %0.3g",
  admin2$name_2, admin2$type_2, admin2$name_0, 
  format(admin2$pop, big.mark = ",", scientific = FALSE, digits = 0), admin2$prop_ov65,
  admin2$deaths_total,
  admin2$pseektrthc10x10
) %>% lapply(htmltools::HTML)


leaflet() %>%
  fitBounds(-25.35875, -40.37063, 63.5003, 37.54327) %>% # from bbox(admin2)
  addTiles() %>%
   addPolygons(data = admin2,
    fillColor = ~pal(inc_per100k),
    weight = 0.5,
    opacity = 1,
    color = "grey",
    dashArray = "",
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    label = labels,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto")) %>%
  addLegend(pal = pal,  
            values = admin2$inc_per100k, opacity = 0.7, 
            position = "bottomright", title = "Deaths per 100,000 persons") 

```


Methods
======================================================================

We estimate infection fatality rates and hospitalization rates from [Verity et al. 2020] from data from the Wuhan outbreak. These are corrected for both asymptomatic infection and underreporting of symptomatic cases. We assume that between 20 - 40 % of people are cummulatively infected.

Figure 1. Predicted IFR by age group

Figure 2. Predicted hospitalization rates by age group.

Importantly the IFRs are estimated from the Wuhan context and could be thought of as a lower bound. Thus, the hospitalization rates it would be important to know how many people die in the absence of ventilators, etc.


<style>

#sidebar.section.sidebar {

  background-color: white; 
  font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif !important;

}

.js-irs-0 .irs-bar {
border-top-color: #d01010;
border-bottom-color: #d01010;
} 

.js-irs-0 .irs-bar-edge {
border-color: #d01010;
}

.js-irs-0 .irs-single, .js-irs-0 .irs-bar-edge, .js-irs-0 .irs-bar {
background: #a00;
}

</style>
